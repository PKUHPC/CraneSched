name: Manage Test and Docs Labels

on:
  workflow_run:
    workflows: [ "Build, Upload and Test" ]
    types:
      - completed
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - edited

jobs:
  manage-labels:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_run' && github.event.workflow_run.event == 'pull_request')
    permissions:
      issues: write
      pull-requests: write
      contents: read
    steps:
      - name: Get PR number
        id: pr-context
        env:
          GH_TOKEN: ${{ github.token }}
          PR_TARGET_REPO: ${{ github.repository }}
          PR_BRANCH: |-
            ${{
              github.event_name == 'pull_request'
                && github.event.pull_request.head.ref
                || (
                  (github.event.workflow_run.head_repository.owner.login != github.event.workflow_run.repository.owner.login)
                    && format('{0}:{1}', github.event.workflow_run.head_repository.owner.login, github.event.workflow_run.head_branch)
                    || github.event.workflow_run.head_branch
                )
            }}
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "pr=${{ github.event.pull_request.number }}" >> "${GITHUB_OUTPUT}"
          else
            gh pr view --repo "${PR_TARGET_REPO}" "${PR_BRANCH}" --json 'number' --jq '"pr=\(.number)"' >> "${GITHUB_OUTPUT}"
          fi

      - name: Manage test and docs labels
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps['pr-context'].outputs.pr }};
            console.log(`Managing labels for PR #${prNumber}`);
            
            // Manage test-passed label (only for workflow_run events)
            if ('${{ github.event_name }}' === 'workflow_run') {
              const conclusion = "${{ github.event.workflow_run.conclusion }}";
              console.log(`Test conclusion: ${conclusion}`);
              
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: "test-passed",
                });
                console.log(`Removed test-passed label from PR #${prNumber}`);
              } catch (error) {
                if (error.status !== 404) {
                  throw error;
                }
              }

              if (conclusion === "success") {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: ["test-passed"],
                });
                console.log(`Added test-passed label to PR #${prNumber}`);
              }
            }
            
            // Manage docs label (for both pull_request and workflow_run events)
            console.log(`Checking docs changes for PR #${prNumber}`);
            
            // Get list of files changed in the PR
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            
            // Check if any file is in the docs directory
            const hasDocsChanges = files.data.some(file => file.filename.startsWith('docs/'));
            
            console.log(`Has docs changes: ${hasDocsChanges}`);
            
            if (hasDocsChanges) {
              // Add docs label
              try {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  labels: ["docs"],
                });
                console.log(`Added docs label to PR #${prNumber}`);
              } catch (error) {
                console.log(`Error adding docs label: ${error.message}`);
              }
            } else {
              // Remove docs label if it exists
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  name: "docs",
                });
                console.log(`Removed docs label from PR #${prNumber}`);
              } catch (error) {
                if (error.status !== 404) {
                  console.log(`Error removing docs label: ${error.message}`);
                }
              }
            }

  validate-pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      pull-requests: read
    steps:
      - name: Validate PR title follows semantic convention
        uses: amannn/action-semantic-pull-request@v6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
